name: Build from ZIP (auto-detect) & Publish
on:
  workflow_dispatch: {}
jobs:
  publish:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: List repo root
        shell: pwsh
        run: |
          Write-Host "== Repo root files =="
          Get-ChildItem -Force | Select-Object Mode,Length,Name

      - name: Find any ZIP in repo root
        id: findzip
        shell: pwsh
        run: |
          $zips = Get-ChildItem -Path . -Filter *.zip -File | Select-Object -ExpandProperty Name
          if ($zips.Count -eq 0) { throw "No ZIP found in repo root. Upload your project ZIP to the root (not inside a folder)." }
          $zip = $zips[0]
          "ZIP_NAME=$zip" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using ZIP: $zip"

      - name: Expand ZIP to ./src
        shell: pwsh
        run: |
          Expand-Archive -Path $env:ZIP_NAME -DestinationPath src -Force
          Write-Host "== Top of src =="
          Get-ChildItem src
          Write-Host "== Searching files (recursive) =="
          Get-ChildItem -Recurse src | Select-Object -First 50 FullName

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Locate solution or project
        id: findpaths
        shell: pwsh
        run: |
          $sln  = Get-ChildItem -Recurse src -Filter *.sln    | Select-Object -First 1
          $proj = Get-ChildItem -Recurse src -Filter *.csproj | Where-Object { $_.FullName -match "LZLogistics.Web" } | Select-Object -First 1
          if (-not $proj) { $proj = Get-ChildItem -Recurse src -Filter *.csproj | Select-Object -First 1 }
          if (-not $sln -and -not $proj) { throw "No .sln or .csproj found under src. Check your ZIP contents." }
          if ($sln)  { "SLN_PATH=$($sln.FullName)"  | Out-File -FilePath $env:GITHUB_ENV -Append; Write-Host "Solution: $($sln.FullName)" }
          if ($proj) { "PROJ_PATH=$($proj.FullName)"| Out-File -FilePath $env:GITHUB_ENV -Append; Write-Host "Project:  $($proj.FullName)" }

      - name: Restore
        shell: pwsh
        run: |
          if ($env:SLN_PATH)  { dotnet restore "$env:SLN_PATH" }
          elseif ($env:PROJ_PATH) { dotnet restore "$env:PROJ_PATH" }
          else { throw "Nothing to restore." }

      - name: Publish (Release)
        shell: pwsh
        run: |
          if ($env:PROJ_PATH) { dotnet publish "$env:PROJ_PATH" -c Release -o out }
          elseif ($env:SLN_PATH) { 
            $proj = Get-ChildItem -Recurse src -Filter *.csproj | Where-Object { $_.FullName -match "LZLogistics.Web" } | Select-Object -First 1
            if (-not $proj) { $proj = Get-ChildItem -Recurse src -Filter *.csproj | Select-Object -First 1 }
            dotnet publish "$($proj.FullName)" -c Release -o out
          }

      - name: Zip publish
        shell: pwsh
        run: Compress-Archive -Path out/* -DestinationPath publish.zip -Force

      - uses: actions/upload-artifact@v4
        with:
          name: lzlogistics-publish
          path: publish.zip
          if-no-files-found: error